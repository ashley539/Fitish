<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f5efe6" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Fitish" />
  <title>Fitish • Your Workouts</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;700;900&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5efe6; --bg2:#ede5d8; --surface:#fdf9f4; --surface2:#f9f2e8;
      --border:rgba(180,155,120,.25); --border2:rgba(180,155,120,.45);
      --text:#1c1814; --muted:#6b5f52; --muted2:#9c8c7c;
      --accent:#5a8a6e; --accent-bg:rgba(90,138,110,.10); --accent-bdr:rgba(90,138,110,.40); --accent-txt:#2d5c43;
      --sand:#c4a882; --sand-bg:rgba(196,168,130,.12); --sand-bdr:rgba(196,168,130,.45);
      --danger:#c0392b; --danger-bg:rgba(192,57,43,.08); --danger-bdr:rgba(192,57,43,.35);
      --ok:#2d7a4f;
      --shadow:0 2px 12px rgba(120,90,60,.10),0 1px 3px rgba(120,90,60,.07);
      --shadow-lg:0 8px 32px rgba(120,90,60,.14),0 2px 8px rgba(120,90,60,.08);
      --radius:16px; --radius2:22px;
      --font-head:'Fraunces',Georgia,serif;
      --font-body:'DM Sans',ui-sans-serif,system-ui,sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:var(--font-body);background:var(--bg);color:var(--text);
      min-height:100vh;display:flex;justify-content:center;padding:16px 14px 28px;
      background-image:
        radial-gradient(ellipse 800px 500px at 15% -5%,rgba(196,168,130,.18),transparent 60%),
        radial-gradient(ellipse 600px 500px at 90% 90%,rgba(90,138,110,.10),transparent 60%);
    }
    .app{width:min(1000px,100%);display:flex;flex-direction:column;gap:12px;}

    /* Topbar */
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 16px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius2);box-shadow:var(--shadow);}
    .brand .title{font-family:var(--font-head);font-weight:900;font-size:20px;letter-spacing:-.3px;}
    .brand .subtitle{font-size:11px;color:var(--muted2);margin-top:1px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .chip{border:1.5px solid var(--border2);background:var(--bg2);color:var(--muted);padding:8px 14px;border-radius:999px;font-size:12px;font-weight:500;cursor:pointer;user-select:none;transition:.15s;}
    .chip:hover{border-color:var(--accent-bdr);color:var(--accent-txt);}
    .chip.active{border-color:var(--accent-bdr);background:var(--accent-bg);color:var(--accent-txt);font-weight:700;}

    /* Layout */
    .grid{display:grid;grid-template-columns:320px 1fr;gap:12px;align-items:start;}
    @media(max-width:860px){.grid{grid-template-columns:1fr;}}

    /* Panel */
    .panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius2);box-shadow:var(--shadow);overflow:hidden;}
    .panel .hd{padding:12px 16px 10px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--border);background:var(--surface2);}
    .panel .hd h2{font-size:11px;letter-spacing:.8px;text-transform:uppercase;color:var(--muted2);font-weight:700;}
    .panel .hd .right{display:flex;gap:8px;align-items:center;}

    /* Buttons */
    .btn{border:1.5px solid var(--border2);background:var(--bg2);color:var(--muted);padding:8px 13px;border-radius:999px;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--font-body);user-select:none;transition:.15s;white-space:nowrap;}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    .btn.primary:hover{background:var(--accent-txt);}
    .btn.ghost{background:transparent;border-color:var(--border2);color:var(--muted);}
    .btn.danger{background:var(--danger-bg);border-color:var(--danger-bdr);color:var(--danger);}

    /* Sidebar */
    .side{padding:14px 16px;display:flex;flex-direction:column;gap:12px;}
    .cardMini{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;display:flex;flex-direction:column;gap:10px;}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .label{color:var(--muted);font-size:12px;font-weight:500;}
    .value{font-weight:700;font-size:13px;color:var(--text);}
    .progress{height:8px;background:var(--bg2);border-radius:999px;overflow:hidden;border:1px solid var(--border);}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--sand));border-radius:999px;transition:width .4s ease;}
    .small{font-size:12px;color:var(--muted2);line-height:1.4;}
    .toggle{display:flex;gap:12px;align-items:center;padding:12px 14px;border-radius:var(--radius);background:var(--surface2);border:1.5px solid var(--border);cursor:pointer;user-select:none;transition:.15s;}
    .toggle .dot{width:20px;height:20px;border-radius:999px;border:2px solid var(--border2);display:grid;place-items:center;flex-shrink:0;transition:.15s;}
    .toggle.on{border-color:var(--accent-bdr);background:var(--accent-bg);}
    .toggle.on .dot{border-color:var(--accent);}
    .toggle .dot:after{content:"";width:10px;height:10px;border-radius:999px;background:transparent;transition:.15s;}
    .toggle.on .dot:after{background:var(--accent);}
    .readinessBg{display:flex;gap:8px;}
    .readBtn{flex:1;padding:9px 6px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface);color:var(--muted);font-size:12px;font-weight:600;text-align:center;cursor:pointer;transition:.15s;font-family:var(--font-body);}
    .readBtn.active{border-color:var(--accent-bdr);background:var(--accent-bg);color:var(--accent-txt);}
    .readBtn:hover{border-color:var(--accent-bdr);}

    /* Workout main */
    .main{padding:14px 16px 18px;display:flex;flex-direction:column;gap:14px;}
    .hero{padding:16px 18px;border-radius:var(--radius2);background:linear-gradient(135deg,var(--accent-bg),var(--sand-bg));border:1.5px solid var(--accent-bdr);}
    .hero .dayTitle{font-family:var(--font-head);font-size:20px;font-weight:900;letter-spacing:-.2px;color:var(--text);line-height:1.2;}
    .hero .intent{color:var(--muted);font-size:12.5px;line-height:1.5;margin-top:4px;}
    .micro{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
    .tag{font-size:11.5px;font-weight:600;padding:5px 10px;border-radius:999px;border:1.5px solid var(--border2);background:var(--surface);color:var(--muted);}
    .tag.accent{border-color:var(--accent-bdr);background:var(--accent-bg);color:var(--accent-txt);}
    .tag.sand{border-color:var(--sand-bdr);background:var(--sand-bg);color:#7a5c30;}

    /* Deck */
    .deckWrap{border-radius:var(--radius2);overflow:hidden;border:1px solid var(--border);background:var(--bg2);}
    .deckTop{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--surface2);border-bottom:1px solid var(--border);gap:10px;flex-wrap:wrap;}
    .deckTop .phase{font-size:11px;color:var(--muted2);letter-spacing:.7px;text-transform:uppercase;font-weight:700;}
    .deckTop .nav{display:flex;gap:6px;align-items:center;}
    .pill{padding:6px 12px;border-radius:999px;border:1.5px solid var(--border2);background:var(--surface);color:var(--muted);font-size:12px;font-weight:600;}
    .deck{touch-action:pan-y;position:relative;min-height:420px;}
    .card{position:absolute;inset:0;padding:12px;display:flex;flex-direction:column;gap:10px;}
    .cardInner{flex:1;display:flex;flex-direction:column;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius2);padding:16px;box-shadow:var(--shadow-lg);}
    .exHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding-bottom:12px;border-bottom:1px solid var(--border);}
    .exHead .name{font-family:var(--font-head);font-size:22px;font-weight:900;letter-spacing:-.3px;color:var(--text);line-height:1.15;}
    .exHead .repsTag{flex-shrink:0;font-size:12px;font-weight:700;padding:6px 12px;border-radius:999px;background:var(--sand-bg);border:1.5px solid var(--sand-bdr);color:#7a5c30;white-space:nowrap;}
    .cuesLabel{font-size:11px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--muted2);margin-bottom:4px;}
    .cues{display:flex;flex-wrap:wrap;gap:6px;}
    .cue{padding:7px 11px;font-size:12px;font-weight:500;border-radius:999px;border:1.5px solid var(--accent-bdr);background:var(--accent-bg);color:var(--accent-txt);}
    .io{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .io .box{border-radius:14px;padding:10px 12px;border:1.5px solid var(--border);background:var(--surface2);display:flex;flex-direction:column;gap:6px;}
    .io .box .label{font-size:11px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;}
    .io .box .value{font-size:15px;font-weight:900;color:var(--text);}
    .io .box .hint{font-size:11px;color:var(--muted2);}
    .io input{width:100%;padding:9px 10px;border-radius:10px;border:1.5px solid var(--border2);background:var(--surface);color:var(--text);font-size:13px;font-family:var(--font-body);font-weight:500;outline:none;transition:border-color .15s;}
    .io input:focus{border-color:var(--accent-bdr);box-shadow:0 0 0 3px var(--accent-bg);}
    .io input::placeholder{color:var(--muted2);}
    .timerBox{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:14px;border:1.5px solid var(--border);background:var(--surface2);transition:.2s;}
    .timerBox.running{border-color:var(--accent-bdr);background:var(--accent-bg);}
    .timerBox .t{font-family:var(--font-head);font-size:24px;font-weight:900;letter-spacing:-.5px;font-variant-numeric:tabular-nums;color:var(--text);}
    .timerBox.running .t{color:var(--accent-txt);}
    .timerBox .sub{font-size:11px;color:var(--muted2);font-weight:500;margin-top:1px;}
    .timerBtns{display:flex;gap:8px;align-items:center;}
    .setRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:auto;padding-top:10px;border-top:1px solid var(--border);}
    .setRow .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .badge{padding:7px 12px;border-radius:999px;background:var(--bg2);border:1.5px solid var(--border2);font-size:12px;font-weight:600;color:var(--muted);}
    .badge.ok{border-color:rgba(45,122,79,.35);color:var(--ok);background:rgba(45,122,79,.08);}
    .badge.sand{border-color:var(--sand-bdr);color:#7a5c30;background:var(--sand-bg);}
    .footerNote{color:var(--muted2);font-size:12px;line-height:1.5;padding:10px 14px;border-radius:var(--radius);background:var(--surface2);border:1px solid var(--border);border-left:3px solid var(--sand);}

    /* Dashboard */
    .dash{padding:14px 16px;display:flex;flex-direction:column;gap:12px;}
    .dashGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media(max-width:480px){.dashGrid{grid-template-columns:1fr;}}
    .stat{border-radius:var(--radius);padding:14px;border:1px solid var(--border);background:var(--surface2);display:flex;flex-direction:column;gap:4px;}
    .stat .k{color:var(--muted2);font-size:11px;text-transform:uppercase;letter-spacing:.6px;font-weight:700;}
    .stat .v{font-family:var(--font-head);font-size:26px;font-weight:900;color:var(--text);}
    .noteBox{border-radius:var(--radius);padding:14px;border:1px solid var(--border);background:var(--surface2);display:flex;flex-direction:column;gap:10px;}
    select{background:var(--surface2);color:var(--text);border:1.5px solid var(--border2);border-radius:999px;padding:8px 12px;font-size:12px;font-weight:600;font-family:var(--font-body);outline:none;cursor:pointer;}
    select:focus{border-color:var(--accent-bdr);}
  </style>
</head>
<body>
<div class="app" id="app"></div>
<script>

/* ================================================================
   FITISH — WORKOUT DATA
   ================================================================
   When updating your programme, share this file with Claude and
   say what you want changed. Claude will update the WORKOUT_PLAN
   below and hand the file back. You then re-upload to GitHub.
   Everything below the "APP LOGIC" marker should be left alone.

   STRUCTURE GUIDE:
   ─ Each day has: name, intent (session goal), tags (shown as pills)
   ─ Blocks group exercises by phase (Activation / Primary / Strength / Conditioning / Core)
   ─ restDefault = rest in SECONDS between sets
   ─ Each exercise has:
       name  — what it's called
       reps  — displayed as-is (e.g. "4×6–8" or "3×10 each side")
       cues  — coaching reminders, shown as green pills on the card
       type  — "load" (log weight + reps)
               "loadOptional" (weight optional)
               "time" (log time in seconds)
               "note" (freetext only)
               "none" (no logging, just cues)
   ================================================================ */

const WORKOUT_PLAN = {

  day1: {
    name: "Day 1 • Lower Body",
    intent: "Glutes + posterior chain. Strong bracing. Clean reps. No neck drama.",
    tags: ["Glutes", "Hamstrings", "Split Squats", "Engine"],
    blocks: [
      {
        phase: "Activation",
        restDefault: 45,
        items: [
          { name: "Banded glute bridges",            reps: "2×15",             cues: ["Glutes first", "Ribs down", "Squeeze, don't arch"],           type: "none" },
          { name: "Banded lateral walks",            reps: "2×10 each way",    cues: ["Feet straight", "Small steps", "Feel side glute"],             type: "none" },
          { name: "Hip hinge drill",                 reps: "2×8",              cues: ["Soft knees", "Hips back", "Hamstrings load"],                  type: "none" },
          { name: "Dead bug",                        reps: "2×6 each side",    cues: ["Low back heavy", "Slow exhale", "Control"],                    type: "none" },
        ]
      },
      {
        phase: "Primary",
        restDefault: 150,
        items: [
          { name: "Heavy deadlifts",                 reps: "4×4–6",            cues: ["Ribs down", "Brace low abs", "Push floor away"],               type: "load" },
        ]
      },
      {
        phase: "Strength",
        restDefault: 120,
        items: [
          { name: "Barbell hip thrusts",             reps: "4×6–8",            cues: ["Chin tucked", "Ribs stacked", "Glutes at top"],                type: "load" },
          { name: "Rear-foot elevated split squats", reps: "3×8 each side",    cues: ["Slight forward torso", "Drive through heel", "Glute feels it"], type: "load" },
        ]
      },
      {
        phase: "Strength",
        restDefault: 90,
        items: [
          { name: "Accessory (choose 1)",            reps: "3 sets",           cues: ["Option A: RDL 3×8", "Option B: Landmine reverse lunge 3×6/side", "Choose what feels best"], type: "note" },
        ]
      },
      {
        phase: "Core",
        restDefault: 60,
        items: [
          { name: "Core (choose 1)",                 reps: "3 sets",           cues: ["Option A: Farmer carries 30–45s", "Option B: Bench plank 30–45s", "Clean bracing"], type: "note" },
        ]
      },
    ]
  },

  day2: {
    name: "Day 2 • Upper Body + Core",
    intent: "Back/arms/shoulders. Controlled heart rate. Quiet neck and jaw.",
    tags: ["Back", "Shoulders", "Bench", "Core"],
    blocks: [
      {
        phase: "Activation",
        restDefault: 45,
        items: [
          { name: "Dead hang (monitor)",             reps: "1–2 sets sub-max", cues: ["Stop well before failure", "Shoulders down", "Breathe"],       type: "time" },
          { name: "Band straight-arm pulldowns",     reps: "2×12",             cues: ["Lats on", "Ribs down", "No shrug"],                            type: "none" },
          { name: "Band pull-aparts",                reps: "2×15",             cues: ["Shoulders low", "Squeeze upper back", "Slow"],                 type: "none" },
          { name: "Pallof press (activation)",       reps: "2×10 each side",   cues: ["Ribs down", "No rotation", "Exhale"],                          type: "none" },
        ]
      },
      {
        phase: "Primary",
        restDefault: 120,
        items: [
          { name: "Landmine row",                    reps: "4×8 each side",    cues: ["Pull elbow to hip", "Chest proud", "No neck tension"],          type: "load" },
        ]
      },
      {
        phase: "Strength",
        restDefault: 120,
        items: [
          { name: "Barbell bench press",             reps: "4×6–8",            cues: ["Wrists stacked", "Shoulders down/back", "Press smooth"],        type: "load" },
          { name: "Landmine shoulder press",         reps: "3×6–8",            cues: ["Ribs down", "Press forward + up", "No lean back"],              type: "load" },
        ]
      },
      {
        phase: "Strength",
        restDefault: 75,
        items: [
          { name: "Dumbbell bicep curls",            reps: "3×10–12",          cues: ["Elbows still", "Full range", "Control"],                        type: "loadOptional" },
          { name: "Bench dips",                      reps: "3×10–12",          cues: ["Shoulders down", "Elbows track back", "Smooth reps"],           type: "loadOptional" },
        ]
      },
      {
        phase: "Core",
        restDefault: 60,
        items: [
          { name: "Banded crunches",                 reps: "3×10–15",          cues: ["Exhale hard", "Ribs down", "Curl, don't yank neck"],            type: "none" },
        ]
      },
    ]
  },

  day3: {
    name: "Day 3 • Compound / CrossFit Style",
    intent: "Athletic full-body. Heart rate up but controlled. Fun, clean, repeatable.",
    tags: ["Landmine", "Ropes", "Athletic", "Rotations"],
    blocks: [
      {
        phase: "Activation",
        restDefault: 45,
        items: [
          { name: "World's Greatest Stretch",        reps: "4 each side",      cues: ["Breathe", "Open hips", "Rotate gently"],                       type: "none" },
          { name: "Glute bridges",                   reps: "2×12",             cues: ["Glutes on", "Ribs down", "No low-back arch"],                  type: "none" },
          { name: "Hip hinge drill",                 reps: "2×8",              cues: ["Hamstrings load", "Neutral spine", "Slow"],                    type: "none" },
          { name: "Shoulder CARs / arm circles",     reps: "5 each direction", cues: ["Smooth", "No pinching", "Warm joints"],                        type: "none" },
        ]
      },
      {
        phase: "Primary",
        restDefault: 120,
        items: [
          { name: "Landmine squat to press",         reps: "4×6",              cues: ["Glutes drive squat", "Exhale on press", "Stay stacked"],        type: "load" },
        ]
      },
      {
        phase: "Strength",
        restDefault: 120,
        items: [
          { name: "Power/Strength (choose 1)",       reps: "3 sets",           cues: ["Option A: Landmine clean to press 3×5/side", "Option B: Barbell RDL (moderate) 3×8", "Choose quality"], type: "note" },
        ]
      },
      {
        phase: "Conditioning",
        restDefault: 60,
        items: [
          { name: "Circuit (3–4 rounds)",            reps: "Continuous",       cues: ["Battle ropes 30s", "Step-ups OR landmine reverse lunge 8/side", "Landmine row 10–12 reps"], type: "note" },
        ]
      },
      {
        phase: "Core",
        restDefault: 60,
        items: [
          { name: "Landmine rotations",              reps: "3×6–8 each side",  cues: ["Arms straight", "Smooth rotation", "Obliques work"],            type: "none" },
        ]
      },
    ]
  }

};

/* ================================================================
   APP LOGIC — leave this section alone
   ================================================================ */

const LS_KEY = "fitish_app_v2";
const PHASES = ["Activation","Primary","Strength","Conditioning","Core"];
const microCues = { Activation:"Primed.", Primary:"Strong.", Strength:"Building.", Conditioning:"Earned.", Core:"Locked in." };

// Attach stable IDs from exercise names so history survives plan rewrites
(function attachIds(){
  Object.values(WORKOUT_PLAN).forEach(day=>{
    day.blocks.forEach(block=>{
      block.items.forEach(item=>{
        item.id = item.name.toLowerCase().replace(/[^a-z0-9]+/g,"_").slice(0,40);
      });
    });
  });
})();

const defaultState = {
  view:"workout", selectedDay:"day2", readiness:2, mesMode:false,
  workout:{ phaseIndex:0, cardIndex:0, setIndex:1, timerRunning:false, timerEndsAt:null },
  logs:{ sessions:[], exerciseHistory:{} }
};

let state = loadState();
render();

function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultState);
    return deepMerge(structuredClone(defaultState),JSON.parse(raw));
  }catch(e){ return structuredClone(defaultState); }
}
function saveState(){ localStorage.setItem(LS_KEY,JSON.stringify(state)); }
function deepMerge(base,inc){
  for(const k in inc){
    if(inc[k]&&typeof inc[k]==="object"&&!Array.isArray(inc[k])) base[k]=deepMerge(base[k]||{},inc[k]);
    else base[k]=inc[k];
  }
  return base;
}

function todayISO(){
  const d=new Date(),p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
}
function weekKeyISO(){
  const d=new Date(),oj=new Date(d.getFullYear(),0,1);
  const day=(oj.getDay()+6)%7;
  return `${d.getFullYear()}-W${String(Math.floor(((d-oj)/86400000+day)/7)+1).padStart(2,"0")}`;
}
function vibrate(ms=60){ if(navigator.vibrate) navigator.vibrate(ms); }
function beep(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine";o.frequency.value=700;g.gain.value=0.05;
    o.connect(g);g.connect(ctx.destination);
    o.start();setTimeout(()=>{o.stop();ctx.close();},180);
  }catch(e){}
}
function formatTime(s){ return `${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`; }
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }

/* Render */
function render(){
  const app=document.getElementById("app");
  app.innerHTML="";
  app.appendChild(topbar());
  if(state.view==="dashboard"){
    app.appendChild(dashboardPanel());
    app.appendChild(workoutPanelCompact());
  }else{
    app.appendChild(mainGrid());
  }
}

function topbar(){
  const el=div("topbar");
  const left=div("brand");
  left.appendChild(divText("title","Fitish"));
  left.appendChild(divText("subtitle","Your personal workout · saved locally on this device"));
  const tabs=div("tabs");
  tabs.appendChild(chip("Workout",state.view==="workout",()=>{state.view="workout";saveState();render();}));
  tabs.appendChild(chip("Dashboard",state.view==="dashboard",()=>{state.view="dashboard";saveState();render();}));
  el.appendChild(left);el.appendChild(tabs);
  return el;
}
function mainGrid(){
  const wrap=div("grid");
  wrap.appendChild(sidePanel());
  wrap.appendChild(workoutPanel());
  return wrap;
}

function sidePanel(){
  const p=panel("Session Setup",[button("Reset","ghost",resetWorkoutState),button("Clear data","danger",clearAllData)]);
  const content=div("side");

  const readCard=div("cardMini");
  readCard.appendChild(divText("label","How are you feeling today?"));
  const rbg=div("readinessBg");
  ["Low","Medium","High"].forEach((lbl,i)=>{
    const b=div("readBtn"+(state.readiness===(i+1)?" active":""));
    b.textContent=lbl;
    b.onclick=()=>{state.readiness=i+1;saveState();render();};
    rbg.appendChild(b);
  });
  readCard.appendChild(rbg);
  readCard.appendChild(divText("small",readinessLabel(state.readiness)));
  content.appendChild(readCard);

  content.appendChild(toggle("Minimum effective session",state.mesMode,(on)=>{state.mesMode=on;saveState();render();}));

  const prog=div("cardMini");
  const activeB=getActiveBlocks();
  const phaseName=PHASES[state.workout.phaseIndex]||"Activation";
  prog.appendChild(rowKV("Progress",phaseName));
  const pr=div("progress");
  const bar=document.createElement("div");
  bar.style.width=`${Math.min(100,Math.round((state.workout.phaseIndex/Math.max(1,activeB.length-1))*100))}%`;
  pr.appendChild(bar);prog.appendChild(pr);
  prog.appendChild(divText("small",`Phase ${state.workout.phaseIndex+1} of ${activeB.length} · ${microCues[phaseName]||"Ready."}`));
  content.appendChild(prog);

  const ref=div("cardMini");
  ref.appendChild(divText("label","Post-workout reflection"));
  ref.appendChild(divText("small","Log how it felt: neck, energy, joints. Patterns add up."));
  ref.appendChild(button("Log reflection","primary",()=>openReflectionModal()));
  content.appendChild(ref);

  p.body.appendChild(content);
  return p.el;
}

function workoutPanel(){
  const day=WORKOUT_PLAN[state.selectedDay];
  const p=panel("Workout",[dayPicker(),button("Finish + log","primary",finishSession)]);
  const content=div("main");
  const hero=div("hero");
  hero.appendChild(divText("dayTitle",day.name));
  hero.appendChild(divText("intent",day.intent));
  const micro=div("micro");
  day.tags.forEach((t,i)=>micro.appendChild(tag(t,i%2===0?"accent":"sand")));
  hero.appendChild(micro);
  content.appendChild(hero);
  content.appendChild(deck(day));
  content.appendChild(divText("footerNote","If your neck tightens, your jaw is doing too much — tongue resting (not pressing), ribs down. Quality over chaos."));
  p.body.appendChild(content);
  return p.el;
}

function workoutPanelCompact(){
  const p=panel("Quick Start",[dayPicker(),button("Start workout","primary",()=>{state.view="workout";saveState();render();})]);
  const content=div("side");
  const day=WORKOUT_PLAN[state.selectedDay];
  const c=div("cardMini");
  c.appendChild(rowKV("Selected",day.name));
  c.appendChild(divText("small",day.intent));
  content.appendChild(c);
  p.body.appendChild(content);
  return p.el;
}

function dayPicker(){
  const sel=document.createElement("select");
  Object.keys(WORKOUT_PLAN).forEach(k=>{
    const opt=document.createElement("option");
    opt.value=k;opt.textContent=WORKOUT_PLAN[k].name;
    if(k===state.selectedDay) opt.selected=true;
    sel.appendChild(opt);
  });
  sel.onchange=()=>{
    state.selectedDay=sel.value;
    Object.assign(state.workout,{phaseIndex:0,cardIndex:0,setIndex:1,timerRunning:false,timerEndsAt:null});
    saveState();render();
  };
  return sel;
}

function deck(day){
  const activeBlocks=getActiveBlocks();
  const block=activeBlocks[state.workout.phaseIndex]||activeBlocks[0];
  const phaseName=block?.phase||"—";
  const phaseCards=block?.items||[];
  state.workout.cardIndex=clamp(state.workout.cardIndex,0,Math.max(0,phaseCards.length-1));
  const idx=state.workout.cardIndex;
  const wrap=div("deckWrap");
  const top=div("deckTop");
  top.appendChild(divText("phase",`Phase: ${phaseName}`));
  const nav=div("nav");
  nav.appendChild(button("◀","ghost",()=>moveCard(-1)));
  nav.appendChild(divText("pill",`${idx+1} / ${phaseCards.length||1}`));
  nav.appendChild(button("▶","ghost",()=>moveCard(1)));
  nav.appendChild(button("Next phase →","primary",nextPhase));
  top.appendChild(nav);wrap.appendChild(top);
  const deckEl=div("deck");
  let startX=null;
  deckEl.addEventListener("touchstart",(e)=>{ if(e.touches?.length) startX=e.touches[0].clientX; },{passive:true});
  deckEl.addEventListener("touchend",(e)=>{
    if(startX===null) return;
    const dx=e.changedTouches[0].clientX-startX;startX=null;
    if(Math.abs(dx)<45) return;
    dx<0?moveCard(1):moveCard(-1);
  },{passive:true});
  if(phaseCards.length) deckEl.appendChild(exerciseCard(phaseName,phaseCards[idx],block.restDefault));
  else{
    const empty=div("card");
    empty.innerHTML=`<div class="cardInner"><div class="exHead"><div class="name">Nothing here</div></div><div class="small">Move to the next phase.</div></div>`;
    deckEl.appendChild(empty);
  }
  wrap.appendChild(deckEl);
  return wrap;
}

function exerciseCard(phaseName,exercise,restDefault){
  const card=div("card");
  const inner=div("cardInner");

  const head=div("exHead");
  const name=div("name");name.textContent=exercise.name;
  const repsTag=div("repsTag");repsTag.textContent=exercise.reps;
  head.appendChild(name);head.appendChild(repsTag);
  inner.appendChild(head);

  const cuesWrap=document.createElement("div");
  cuesWrap.appendChild(divText("cuesLabel","Cues"));
  const cues=div("cues");
  (exercise.cues||[]).forEach(c=>{const ce=div("cue");ce.textContent=c;cues.appendChild(ce);});
  cuesWrap.appendChild(cues);
  inner.appendChild(cuesWrap);

  const io=div("io");
  const hist=getLastHistory(exercise.id);
  const box1=div("box");
  box1.appendChild(divText("label","Last time"));
  box1.appendChild(divText("value",hist?.weight?`${hist.weight} kg`:"—"));
  box1.appendChild(divText("hint",hist?.repsText||"No log yet"));
  io.appendChild(box1);
  const box2=div("box");
  box2.appendChild(divText("label","Today"));
  const inp=document.createElement("input");
  inp.value=getDraftWeight(exercise.id);inp.inputMode="decimal";
  inp.oninput=()=>setDraftWeight(exercise.id,inp.value);
  const inp2=document.createElement("input");
  inp2.placeholder="Reps e.g. 6,6,6";inp2.value=getDraftReps(exercise.id);
  inp2.oninput=()=>setDraftReps(exercise.id,inp2.value);
  if(["load","loadOptional"].includes(exercise.type)){
    inp.placeholder="Weight (kg)";box2.appendChild(inp);box2.appendChild(inp2);
  }else if(exercise.type==="time"){
    inp.placeholder="Time (sec)";box2.appendChild(inp);box2.appendChild(inp2);
  }else{
    inp.placeholder="Notes (optional)";box2.appendChild(inp);
  }
  io.appendChild(box2);inner.appendChild(io);

  const isRunning=state.workout.timerRunning;
  const timerBox=div("timerBox"+(isRunning?" running":""));
  const timerLeft=document.createElement("div");
  timerLeft.appendChild(divText("t",isRunning?timeLeftText():formatTime(restDefault||60)));
  timerLeft.appendChild(divText("sub",isRunning?"Resting…":"Suggested rest"));
  timerBox.appendChild(timerLeft);
  const timerBtns=div("timerBtns");
  timerBtns.appendChild(button("Log set","primary",()=>logSet(exercise,restDefault)));
  timerBtns.appendChild(button(isRunning?"Running…":"Start rest","ghost",()=>startRest(restDefault||60)));
  timerBox.appendChild(timerBtns);inner.appendChild(timerBox);

  const setRow=div("setRow");
  const leftRow=div("left");
  const b1=div("badge");b1.textContent=`Set ${state.workout.setIndex}`;
  const b2=div("badge ok");b2.textContent=microCues[phaseName]||"Ready.";
  leftRow.appendChild(b1);leftRow.appendChild(b2);setRow.appendChild(leftRow);
  const b3=div("badge sand");b3.textContent=state.mesMode?"Min. effective":readinessHint(state.readiness);
  setRow.appendChild(b3);inner.appendChild(setRow);
  card.appendChild(inner);
  if(state.workout.timerRunning) scheduleTimerTick();
  return card;
}

function getActiveBlocks(){
  const blocks=WORKOUT_PLAN[state.selectedDay].blocks;
  if(!state.mesMode) return blocks;
  return blocks.filter(b=>["Activation","Primary","Core"].includes(b.phase));
}
function moveCard(dir){
  const blocks=getActiveBlocks();
  const max=(blocks[state.workout.phaseIndex]?.items?.length||1)-1;
  state.workout.cardIndex=clamp(state.workout.cardIndex+dir,0,Math.max(0,max));
  state.workout.setIndex=1;saveState();render();
}
function nextPhase(){
  const blocks=getActiveBlocks();
  if(state.workout.phaseIndex<blocks.length-1){
    state.workout.phaseIndex+=1;state.workout.cardIndex=0;
    state.workout.setIndex=1;saveState();render();vibrate(30);
  }else{ openReflectionModal(); }
}
function logSet(exercise,restDefault){
  const w=getDraftWeight(exercise.id).trim();
  const r=getDraftReps(exercise.id).trim();
  const needsInput=["load","loadOptional","time"].includes(exercise.type);
  if(needsInput&&!w&&!r){toast("Add weight or reps first.");return;}
  if(!state.logs.exerciseHistory[exercise.id]) state.logs.exerciseHistory[exercise.id]=[];
  state.logs.exerciseHistory[exercise.id].unshift({dateISO:todayISO(),weight:w,repsText:r||exercise.reps});
  state.workout.setIndex+=1;vibrate(25);saveState();render();
  toast(`Set logged · rest ${formatTime(restDefault||60)}`);
}
function startRest(seconds){
  state.workout.timerRunning=true;state.workout.timerEndsAt=Date.now()+seconds*1000;
  saveState();render();scheduleTimerTick();
}
let timerTickScheduled=false;
function scheduleTimerTick(){
  if(timerTickScheduled) return;timerTickScheduled=true;
  const tick=()=>{
    timerTickScheduled=false;if(!state.workout.timerRunning) return;
    const left=Math.max(0,Math.ceil((state.workout.timerEndsAt-Date.now())/1000));
    if(left<=0){
      state.workout.timerRunning=false;state.workout.timerEndsAt=null;
      vibrate(90);beep();toast("Rest done — next set ready.");
      saveState();render();return;
    }
    setTimeout(()=>{saveState();render();},800);
  };
  setTimeout(tick,250);
}
function timeLeftText(){ return formatTime(Math.max(0,Math.ceil((state.workout.timerEndsAt-Date.now())/1000))); }
function finishSession(){ openReflectionModal(true); }
function resetWorkoutState(){
  Object.assign(state.workout,{phaseIndex:0,cardIndex:0,setIndex:1,timerRunning:false,timerEndsAt:null});
  saveState();render();toast("Reset.");
}
function clearAllData(){
  if(!confirm("Clear all saved logs and settings?")) return;
  localStorage.removeItem(LS_KEY);state=structuredClone(defaultState);render();
}

function dashboardPanel(){
  const p=panel("Dashboard",[
    button("Export data","ghost",exportData),
    button("Back to workout","primary",()=>{state.view="workout";saveState();render();})
  ]);
  const content=div("dash");
  const wk=weekKeyISO();
  const sw=state.logs.sessions.filter(s=>s.weekKey===wk);
  const g=div("dashGrid");
  g.appendChild(stat("Sessions this week",`${sw.length}`));
  g.appendChild(stat("Sets this week",`${sw.reduce((a,s)=>a+(s.totalSets||0),0)}`));
  const vol=sw.reduce((a,s)=>a+(s.totalVolume||0),0);
  g.appendChild(stat("Volume this week",vol?`${Math.round(vol)} kg`:"—"));
  g.appendChild(stat("Exercises tracked",`${Object.keys(state.logs.exerciseHistory).length}`));
  content.appendChild(g);
  const recent=div("noteBox");
  recent.appendChild(divText("label","Recent sessions"));
  const list=document.createElement("div");list.style.cssText="display:flex;flex-direction:column;gap:8px;";
  const last=state.logs.sessions.slice(-5).reverse();
  if(!last.length){ list.appendChild(divText("small","No sessions logged yet. Finish a workout to log one.")); }
  else{
    last.forEach(s=>{
      const item=div("cardMini");item.style.padding="10px";
      item.appendChild(rowKV(`${s.dateISO} · ${WORKOUT_PLAN[s.dayKey]?.name||s.dayKey}`,`${s.totalSets||0} sets`));
      item.appendChild(divText("small",`${summariseReflections(s.reflections)}${s.notes?" · Notes saved":""}`));
      list.appendChild(item);
    });
  }
  recent.appendChild(list);content.appendChild(recent);
  p.body.appendChild(content);return p.el;
}
function exportData(){
  const payload=JSON.stringify(state,null,2);
  navigator.clipboard?.writeText(payload).then(()=>toast("Copied to clipboard.")).catch(()=>prompt("Copy your data:",payload));
}

function openReflectionModal(fromFinish=false){
  const reflections={
    neck:confirm("Neck tension today?"),
    wrists:confirm("Wrist discomfort today?"),
    knee:confirm("Knee/ankle discomfort today?"),
    strong:confirm("Did you feel strong today?"),
  };
  const notes=prompt("Quick notes? (Optional)","");
  const today=todayISO();let count=0,v=0;
  Object.values(state.logs.exerciseHistory).forEach(arr=>{if(arr?.[0]?.dateISO===today)count++;});
  Object.keys(state.logs.exerciseHistory).forEach(id=>{
    const e=state.logs.exerciseHistory[id]?.find(x=>x.dateISO===today);
    if(e?.weight){const w=parseFloat(e.weight);if(!isNaN(w))v+=w;}
  });
  state.logs.sessions.push({
    dateISO:today,weekKey:weekKeyISO(),dayKey:state.selectedDay,
    totalSets:count?count*3:0,totalVolume:v?v*10:0,reflections,notes:notes||""
  });
  saveState();toast("Session logged ✓");
  if(fromFinish) Object.assign(state.workout,{phaseIndex:0,cardIndex:0,setIndex:1});
  render();
}
function summariseReflections(r){
  if(!r) return "—";
  const bits=[];
  if(r.strong) bits.push("Strong");if(r.neck) bits.push("Neck");
  if(r.wrists) bits.push("Wrists");if(r.knee) bits.push("Knee/ankle");
  return bits.length?bits.join(", "):"—";
}

function getDraftWeight(id){ state._draft=state._draft||{};state._draft[id]=state._draft[id]||{};return state._draft[id].w||""; }
function setDraftWeight(id,val){ state._draft=state._draft||{};state._draft[id]=state._draft[id]||{};state._draft[id].w=val;saveState(); }
function getDraftReps(id){ state._draft=state._draft||{};state._draft[id]=state._draft[id]||{};return state._draft[id].r||""; }
function setDraftReps(id,val){ state._draft=state._draft||{};state._draft[id]=state._draft[id]||{};state._draft[id].r=val;saveState(); }
function getLastHistory(id){ const arr=state.logs.exerciseHistory[id];return arr?.length?arr[0]:null; }

function panel(title,actions=[]){
  const el=div("panel");const hd=div("hd");
  const h2=document.createElement("h2");h2.textContent=title;hd.appendChild(h2);
  const right=div("right");actions.forEach(a=>right.appendChild(a));hd.appendChild(right);
  el.appendChild(hd);const body=document.createElement("div");el.appendChild(body);
  return{el,body};
}
function chip(label,active,onClick){
  const el=div("chip"+(active?" active":""));el.textContent=label;el.onclick=onClick;return el;
}
function button(label,cls,onClick){
  const b=document.createElement("button");
  b.className=`btn ${cls||""}`.trim();b.textContent=label;b.onclick=onClick;return b;
}
function tag(text,cls){ const t=div(`tag ${cls||""}`.trim());t.textContent=text;return t; }
function toggle(label,on,onChange){
  const t=div("toggle"+(on?" on":""));
  const dot=div("dot");
  const txt=document.createElement("div");
  txt.style.cssText="display:flex;flex-direction:column;gap:2px;";
  txt.innerHTML=`<div style="font-weight:700;font-size:13px">${label}</div><div class="small">${on?"On — primary blocks only":"Off — full programme"}</div>`;
  t.appendChild(dot);t.appendChild(txt);t.onclick=()=>onChange(!on);return t;
}
function rowKV(k,v){
  const r=div("row");r.appendChild(divText("label",k));
  if(v!==undefined&&v!==null&&v!=="") r.appendChild(divText("value",v));
  return r;
}
function stat(k,v){ const s=div("stat");s.appendChild(divText("k",k));s.appendChild(divText("v",v));return s; }
function div(cls){ const d=document.createElement("div");d.className=cls;return d; }
function divText(cls,text){ const d=document.createElement("div");d.className=cls;d.textContent=text;return d; }
function readinessLabel(n){
  return["Low energy — minimum effective session is a full win today.","Steady energy — controlled, momentum-building session.","High energy — push quality, stay clean, enjoy it."][n-1]||"";
}
function readinessHint(n){ return["Low energy","Medium energy","High energy"][n-1]||""; }

let toastTimer=null;
function toast(msg){
  clearTimeout(toastTimer);
  let el=document.getElementById("toast");
  if(!el){
    el=document.createElement("div");el.id="toast";
    Object.assign(el.style,{
      position:"fixed",left:"50%",bottom:"20px",transform:"translateX(-50%)",
      padding:"10px 18px",borderRadius:"999px",
      background:"var(--text)",color:"var(--surface)",
      fontSize:"13px",fontWeight:"600",fontFamily:"var(--font-body)",
      border:"none",zIndex:"9999",
      boxShadow:"0 4px 20px rgba(0,0,0,.18)",transition:"opacity .2s"
    });
    document.body.appendChild(el);
  }
  el.textContent=msg;el.style.opacity="1";
  toastTimer=setTimeout(()=>el.style.opacity="0",2400);
}
</script>
</body>
</html>
